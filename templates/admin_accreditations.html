{% extends "base.html" %}
{% block title %}Admin · Accreditations{% endblock %}
{% block content %}
<section class="wrap">

  <div class="flex-between" style="margin-bottom:14px">
    <h1 class="mt-0">Admin · Accreditations</h1>
    <div class="inline-actions">
      <a class="btn btn-outline" href="{{ url_for('admin.admin_logout') }}">Admin logout</a>
    </div>
  </div>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="flash {{ category }}">{{ message }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- ADD NEW -->
  <div class="card" style="margin-bottom:14px">
    <h2 class="mt-0">Add accreditation</h2>
    <form method="post" class="grid grid-3 grid-equal" action="{{ url_for('admin.admin_accreditations') }}">
      <input type="hidden" name="action" value="add">

      <label class="field">
        <span class="label">Name</span>
        <input type="text" name="name" required placeholder="e.g., Leeds Rental Standard">
      </label>

      <label class="field" style="grid-column:1 / -1">
        <span class="label">Help text (optional)</span>
        <input type="text" name="help_text" placeholder="Shown to landlords next to the checkbox (e.g., 'Enter membership number in the notes field').">
      </label>

      <div class="field" style="display:flex; align-items:flex-end; gap:16px">
        <label class="checkbox" style="margin:0">
          <input type="checkbox" name="is_active" checked>
          <span>Active</span>
        </label>
        <button class="btn" type="submit" style="margin-left:auto">Add</button>
      </div>
    </form>
  </div>

  <!-- LIST / EDIT / STATUS / REORDER -->
  <div class="card">
    <h2 class="mt-0">Accreditations</h2>

    {% if items and items|length %}

      <!-- Dedicated (empty) reorder form. Inputs below reference it via form="reorderForm". -->
      <form id="reorderForm" method="post" action="{{ url_for('admin.admin_accreditations') }}">
        <input type="hidden" name="action" value="reorder">
      </form>

      <table class="table" style="margin-top:10px">
        <thead>
          <tr>
            <th style="width:64px">ID</th>
            <th>Name &amp; help</th>
            <th style="width:120px">Slug</th>
            <th style="width:120px">Status</th>
            <th style="width:110px">Sort</th>
            <th style="width:420px">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for it in items %}
            <tr id="row-{{ it.id }}">
              <td>{{ it.id }}</td>

              <!-- Static summary (always visible) -->
              <td>
                <div><strong>{{ it.name }}</strong></div>
                {% if it.help_text %}
                  <div class="small muted">{{ it.help_text }}</div>
                {% else %}
                  <div class="small muted">—</div>
                {% endif %}

                <!-- Inline edit form (hidden until “Edit”) -->
                <form method="post"
                      action="{{ url_for('admin.admin_accreditations') }}"
                      id="editform-{{ it.id }}"
                      style="display:none; margin-top:8px; gap:8px; align-items:center; flex-wrap:wrap"
                      class="inline-edit">
                  <input type="hidden" name="action" value="edit">
                  <input type="hidden" name="id" value="{{ it.id }}">
                  <input type="text" name="name" value="{{ it.name }}" style="min-width:240px" placeholder="Name">
                  <input type="text" name="help_text" value="{{ it.help_text }}" placeholder="Help text (optional)" style="min-width:260px">
                  <label class="checkbox" style="margin:0 8px;">
                    <input type="checkbox" name="is_active" {% if it.is_active %}checked{% endif %}>
                    <span>Active</span>
                  </label>
                  <button class="btn btn-outline" type="submit">Save</button>
                  <button class="btn btn-outline" type="button" onclick="toggleEdit({{ it.id }}, false)">Cancel</button>
                </form>
              </td>

              <td class="mono small">{{ it.slug }}</td>

              <td>
                {% if it.is_active %}
                  <span class="badge">Active</span>
                {% else %}
                  <span class="badge" style="background:#fff6f6; color:#7f1d1d; border:1px solid #f7caca;">Disabled</span>
                {% endif %}
              </td>

              <td>
                <!-- This input belongs to the separate reorderForm via the 'form' attribute -->
                <input type="number" name="order_{{ it.id }}" value="{{ it.sort_order }}" style="width:90px" form="reorderForm">
              </td>

              <td>
                <div class="inline-actions">
                  <!-- Edit button toggles the hidden form -->
                  <button class="btn" type="button" onclick="toggleEdit({{ it.id }}, true)">Edit</button>

                  <!-- Activate / Deactivate -->
                  <form method="post" action="{{ url_for('admin.admin_accreditations') }}" style="display:inline">
                    <input type="hidden" name="id" value="{{ it.id }}">
                    {% if it.is_active %}
                      <input type="hidden" name="action" value="deactivate">
                      <button class="btn btn-outline" type="submit">Disable</button>
                    {% else %}
                      <input type="hidden" name="action" value="activate">
                      <button class="btn" type="submit">Activate</button>
                    {% endif %}
                  </form>

                  <!-- Delete -->
                  <form method="post"
                        action="{{ url_for('admin.admin_accreditations') }}"
                        style="display:inline"
                        onsubmit="return confirm('Delete {{ it.name }}? This cannot be undone.');">
                    <input type="hidden" name="action" value="delete">
                    <input type="hidden" name="id" value="{{ it.id }}">
                    <button class="btn btn-admin" type="submit">Delete</button>
                  </form>
                </div>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>

      <div class="flex-between" style="margin-top:10px">
        <span class="muted small">Tip: lower sort numbers appear first.</span>
        <button class="btn" type="submit" form="reorderForm">Save order</button>
      </div>

    {% else %}
      <p class="muted">No accreditations yet. Add your first one above.</p>
    {% endif %}
  </div>

</section>

<script>
  function toggleEdit(id, show) {
    const form = document.getElementById('editform-' + id);
    if (!form) return;
    form.style.display = show ? 'flex' : 'none';
    if (show) {
      const input = form.querySelector('input[type="text"]');
      if (input) input.focus();
    }
  }
</script>
{% endblock %}
