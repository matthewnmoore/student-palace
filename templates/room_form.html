{% extends "base.html" %}
{% block title %}{{ 'Add room' if mode=='new' else 'Edit room' }} – Student Palace{% endblock %}
{% block content %}
<section class="wrap">
  <h1 class="page-title">{{ 'Add a room' if mode=='new' else 'Edit room' }}</h1>
  <p class="muted" style="margin-top:-6px">{{ house.title }} • {{ house.city }}</p>

  <form method="post" class="form-stacked">
    <!-- BASICS -->
    <div class="card card--accent-lr">
      <h2 class="card-title">Basics</h2>
      <!-- Row 1 -->
      <div class="grid" style="grid-template-columns:repeat(4,minmax(180px,1fr)); gap:14px; align-items:end">
        <label class="field">
          <span class="label">Room name</span>
          <input type="text" name="name" value="{{ (form.name or '') if form else '' }}" required placeholder="e.g., Room 1, Attic room">
        </label>

        <label class="field">
          <span class="label">Price per month (£)</span>
          <input type="number" id="price_pcm" name="price_pcm" value="{{ (form.price_pcm or '') if form else '' }}" min="0" step="1" inputmode="numeric" placeholder="e.g., 650">
        </label>

        <label class="field">
          <span class="label">Price per week (£)</span>
          <input type="text" id="price_ppw" value="" readonly>
        </label>

        <label class="field">
          <span class="label">Approx. room size</span>
          <input type="text" name="room_size" value="{{ (form.room_size or '') if form else '' }}" placeholder="e.g., 10 m²">
        </label>
      </div>

      <!-- Row 2 -->
      <div class="grid" style="grid-template-columns:1fr 2fr; gap:30px; margin-top:10px; align-items:end">
        <label class="field">
          <span class="label">Bed size</span>
          {% set bed = (form.bed_size or '') if form else '' %}
          <select name="bed_size" required style="width:100%; padding:10px; border:1px solid var(--border); border-radius:10px; font-size:14px; min-height:44px; background:#fff">
            <option value="" {% if not bed %}selected{% endif %}>Choose bed size</option>
            <option value="Single" {% if bed=='Single' %}selected{% endif %}>Single</option>
            <option value="Small double" {% if bed=='Small double' %}selected{% endif %}>Small double</option>
            <option value="Double" {% if bed=='Double' %}selected{% endif %}>Double</option>
            <option value="King" {% if bed=='King' %}selected{% endif %}>King</option>
          </select>
        </label>

        <div style="display:flex; align-items:center; gap:40px; flex-wrap:wrap; padding-top:22px">
          <label class="check" style="display:flex; align-items:center; gap:8px; margin:0; white-space:nowrap">
            <input type="checkbox" name="disabled_ok" {% if form and form.disabled_ok in ['1', 1, 'on', True] %}checked{% endif %}>
            <span class="label-inline">Accessible for disabled people</span>
          </label>

          <label class="check" style="display:flex; align-items:center; gap:8px; margin:0; white-space:nowrap">
            <input type="checkbox" name="couples_ok" {% if form and form.couples_ok in ['1', 1, 'on', True] %}checked{% endif %}>
            <span class="label-inline">Suitable for couples</span>
          </label>
        </div>
      </div>
    </div>

    <!-- AVAILABILITY -->
    <div class="card card--accent-lr">
      <h2 class="card-title">Availability</h2>
      <div class="grid grid-3" style="align-items:end">
        <label class="check" style="align-self:end">
          <input type="checkbox" name="is_let" id="is_let" value="1"
                 {% if form and form.is_let in ['1', 1, 'on', True] %}checked{% endif %}>
          <span>Currently let (not available now)</span>
        </label>
        <!-- Hidden default so unchecked submits 0 -->
        <input type="hidden" name="is_let" value="0">

        {% set let_until_val = (form.let_until or '') if form else '' %}
        <label class="field" id="row_let_until" style="display:none">
          <span class="label-inline" style="margin-bottom:0">Let until</span>
          <input type="date" name="let_until" id="let_until" value="{{ let_until_val }}">
        </label>

        {% set available_from_val = (form.available_from or '') if form else '' %}
        <label class="field" id="row_available_from">
          <span class="label-inline" style="margin-bottom:0">Available from</span>
          <input type="date" name="available_from" id="available_from" value="{{ available_from_val }}">
        </label>
      </div>
    </div>

    <!-- FEATURES -->
    <div class="card card--accent-lr">
      <h2 class="card-title">Features</h2>
      <div class="grid grid-3">
        <label class="field checkbox"><input type="checkbox" name="ensuite" {% if form and form.ensuite in ['1', 1, 'on', True] %}checked{% endif %}> <span>Ensuite / own bathroom</span></label>
        <label class="field checkbox"><input type="checkbox" name="tv" {% if form and form.tv in ['1', 1, 'on', True] %}checked{% endif %}> <span>TV in room</span></label>
        <label class="field checkbox"><input type="checkbox" name="desk_chair" {% if form and form.desk_chair in ['1', 1, 'on', True] %}checked{% endif %}> <span>Desk & chair</span></label>
        <label class="field checkbox"><input type="checkbox" name="wardrobe" {% if form and form.wardrobe in ['1', 1, 'on', True] %}checked{% endif %}> <span>Wardrobe</span></label>
        <label class="field checkbox"><input type="checkbox" name="chest_drawers" {% if form and form.chest_drawers in ['1', 1, 'on', True] %}checked{% endif %}> <span>Chest of drawers</span></label>
        <label class="field checkbox"><input type="checkbox" name="lockable_door" {% if form and form.lockable_door in ['1', 1, 'on', True] %}checked{% endif %}> <span>Lockable door</span></label>
        <label class="field checkbox"><input type="checkbox" name="wired_internet" {% if form and form.wired_internet in ['1', 1, 'on', True] %}checked{% endif %}> <span>Wired internet</span></label>
        <label class="field checkbox"><input type="checkbox" name="safe" {% if form and form.safe in ['1', 1, 'on', True] %}checked{% endif %}> <span>Safe</span></label>
        <label class="field checkbox"><input type="checkbox" name="dressing_table" {% if form and form.dressing_table in ['1', 1, 'on', True] %}checked{% endif %}> <span>Dressing table</span></label>
        <label class="field checkbox"><input type="checkbox" name="mirror" {% if form and form.mirror in ['1', 1, 'on', True] %}checked{% endif %}> <span>Mirror</span></label>
        <label class="field checkbox"><input type="checkbox" name="bedside_table" {% if form and form.bedside_table in ['1', 1, 'on', True] %}checked{% endif %}> <span>Bedside table</span></label>
        <label class="field checkbox"><input type="checkbox" name="blinds" {% if form and form.blinds in ['1', 1, 'on', True] %}checked{% endif %}> <span>Blinds</span></label>
        <label class="field checkbox"><input type="checkbox" name="curtains" {% if form and form.curtains in ['1', 1, 'on', True] %}checked{% endif %}> <span>Curtains</span></label>
        <label class="field checkbox"><input type="checkbox" name="sofa" {% if form and form.sofa in ['1', 1, 'on', True] %}checked{% endif %}> <span>Sofa</span></label>
      </div>
    </div>

    <!-- DESCRIPTION (moved below Features) -->
    <div class="card card--accent-lr">
      <h2 class="card-title">Description</h2>
      <div class="field">
        <span class="label">Room description</span>
        <textarea name="description" rows="5" placeholder="Describe the room, furnishings, outlook, any quirks, etc.">{{ (form.description or '') if form else '' }}</textarea>
        <div class="help">Add helpful details students should know (condition, furnishings, outlook, storage, etc.).</div>
      </div>
    </div>

    <!-- ACTIONS -->
    <div class="card actions card--accent-lr">
      <div class="actions-row">
        <div class="btn-group-left" style="display:flex; gap:8px; flex-wrap:wrap; align-items:center">
          <button class="btn" type="submit" name="action" value="save_only">Save</button>
          <button class="btn" type="submit" name="action" value="save_exit">{{ 'Create room' if mode=='new' else 'Save & Exit' }}</button>
          <a class="btn btn-outline" href="{{ url_for('landlord.rooms_list', hid=house.id) }}">Cancel</a>
          {% if mode == 'edit' and room %}
            <a class="btn btn-outline" href="{{ url_for('landlord.room_photos', hid=house.id, rid=room.id) }}">Manage photos</a>
          {% endif %}
        </div>
        <div style="flex-grow:1"></div>
        {% if mode == 'edit' and room %}
          <form method="post" action="{{ url_for('landlord.room_delete', hid=house.id, rid=room.id) }}" onsubmit="return confirm('Delete this room?');" style="display:inline">
            <button class="btn btn-admin" type="submit">Delete room</button>
          </form>
        {% endif %}
      </div>
    </div>
  </form>
</section>

<style>
  .page-title { margin-bottom: 8px; }
  .form-stacked .card { margin-bottom: 14px; }
  .card-title { margin: 0 0 10px 0; }
  .actions .actions-row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
</style>

<!-- Behaviour -->
<script>
(function(){
  var isLet=document.getElementById('is_let');
  var rowLetUntil=document.getElementById('row_let_until');
  var letUntil=document.getElementById('let_until');
  var availFrom=document.getElementById('available_from');

  function isoPlusOneDay(iso){
    if(!iso) return '';
    var d=new Date(iso);
    if(isNaN(d.getTime())) return '';
    d.setDate(d.getDate()+1);
    var y=d.getFullYear();
    var m=String(d.getMonth()+1).padStart(2,'0');
    var dd=String(d.getDate()).padStart(2,'0');
    return y+'-'+m+'-'+dd;
  }

  function prevDay(iso){
    if(!iso) return '';
    var d=new Date(iso);
    if(isNaN(d.getTime())) return '';
    d.setDate(d.getDate()-1);
    var y=d.getFullYear();
    var m=String(d.getMonth()+1).padStart(2,'0');
    var dd=String(d.getDate()).padStart(2,'0');
    return y+'-'+m+'-'+dd;
  }

  function syncVisibility(){
    var checked=isLet && isLet.checked;
    if(rowLetUntil) rowLetUntil.style.display=checked?'block':'none';

    if(!checked && letUntil){
      // room is available → force let_until to day before available_from (or today)
      var af = availFrom && availFrom.value ? availFrom.value : new Date().toISOString().slice(0,10);
      letUntil.value = prevDay(af);
    }
  }

  function wireAutoNextDay(){
    if(!letUntil||!availFrom) return;
    letUntil.addEventListener('change', function(){
      if(!letUntil.value) return;
      var next=isoPlusOneDay(letUntil.value);
      if(next) availFrom.value=next;
    });
  }

  if(isLet){ isLet.addEventListener('change', syncVisibility); }
  syncVisibility();
  wireAutoNextDay();

  var pcmInput=document.getElementById('price_pcm');
  var ppwInput=document.getElementById('price_ppw');
  function updatePPW(){
    var val=parseFloat(pcmInput.value);
    if(!isNaN(val)&&val>0){
      var weekly=Math.round((val*12)/52);
      ppwInput.value=weekly;
    }else{
      ppwInput.value='';
    }
  }
  if(pcmInput){ pcmInput.addEventListener('input', updatePPW); updatePPW(); }
})();
</script>
{% endblock %}
