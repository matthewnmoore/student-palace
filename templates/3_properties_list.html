{% extends "base.html" %}
{% block title %}Properties – Student Palace{% endblock %}

{% block content %}
<section class="wrap" style="margin-top:10px">

  <!-- Toolbar: result count (kept slim, no big banner) -->
  <div class="card card--accent-lr" style="padding:10px 14px; margin-top:0; display:flex; align-items:center; justify-content:space-between; gap:10px;">
    <div class="muted">
      {% set total = results|length if results is defined else 0 %}
      {{ total }} result{{ '' if total==1 else 's' }}
    </div>
    <form method="get" id="sortForm" style="display:flex; gap:8px; align-items:center;">
      {% for k,v in request.args.items() %}
        {% if k!='sort' %}<input type="hidden" name="{{ k }}" value="{{ v|e }}">{% endif %}
      {% endfor %}
      <label class="field" style="margin:0;">
        <span class="label-inline">Sort</span>
        <select name="sort" onchange="this.form.submit()">
          <option value="">Relevance</option>
          <option value="price_asc"  {% if request.args.get('sort')=='price_asc' %}selected{% endif %}>Price (low → high)</option>
          <option value="price_desc" {% if request.args.get('sort')=='price_desc' %}selected{% endif %}>Price (high → low)</option>
          <option value="newest"     {% if request.args.get('sort')=='newest' %}selected{% endif %}>Newest</option>
        </select>
      </label>
    </form>
  </div>

  <!-- Results grid -->
  <div class="grid" style="grid-template-columns:repeat( auto-fill, minmax(280px, 1fr) ); gap:14px; margin-top:12px;">
    {% if results and results|length %}
      {% for h in results %}
        <article class="card property-card" style="overflow:hidden; padding:0;">
          <a href="/p/{{ h.id }}" style="display:block; text-decoration:none; color:inherit;">
            {% if h.cover_url %}
              <img src="{{ h.cover_url }}" alt="" style="width:100%; height:180px; object-fit:cover; display:block;">
            {% else %}
              <div style="height:180px; background:#f3f3f7; display:flex; align-items:center; justify-content:center; color:#999;">No photo</div>
            {% endif %}

            <div class="property-body" style="padding:12px 12px 14px 12px;">
              <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
                <h3 class="prop-title">{{ h.title }}</h3>
                {% set verified = (h.landlord_is_verified if 'landlord_is_verified' in h.keys() else h.is_verified) %}
                {% if verified in [1, '1', true, 'true', 'True'] %}
                  <span title="Verified landlord" aria-hidden="true" style="font-size:18px;">✅</span>
                {% endif %}
              </div>

              {# Short street address (no house number) #}
              {% set full_addr = (h.address or '') ~ (', ' ~ h.city if h.city) %}
              <div class="muted short-address" data-full="{{ full_addr|e }}"></div>

              <div class="badges-3" style="margin-top:8px;">
                <span class="badge">{{ 'Whole house' if h.letting_type=='whole' else 'House share' }}</span>
                {% if (h.bills_option or '') == 'yes' %}
                  <span class="badge">Bills included</span>
                {% endif %}

                {# X rooms • Y available #}
                {% set total_rooms = h.total_rooms if 'total_rooms' in h.keys() else (h.bedrooms_total if 'bedrooms_total' in h.keys() else None) %}
                {% set avail_rooms = h.available_rooms_total if 'available_rooms_total' in h.keys() else None %}
                {% if total_rooms is not none and total_rooms|int >= 0 %}
                  <span class="badge">
                    {{ total_rooms|int }} rooms{% if avail_rooms is not none %} • {{ avail_rooms|int }} available{% endif %}
                  </span>
                {% endif %}

                {# Ensuites available (optional) #}
                {% if (h.ensuites_available|default(0,true)|int) > 0 %}
                  <span class="badge">{{ h.ensuites_available|int }} ensuite</span>
                {% endif %}
              </div>

              {# From price: pcm + pw (no squiggle) #}
              {% set pcm = h.from_price_pcm if 'from_price_pcm' in h.keys() else None %}
              {% set ppw = h.from_price_ppw if 'from_price_ppw' in h.keys() else None %}
              {% if pcm or ppw %}
                <div class="price-line">
                  {% if pcm %}From £{{ pcm|int }} pcm{% endif %}
                  {% if ppw %} ( £{{ ppw|int }} pw ){% endif %}
                </div>
              {% endif %}
            </div>
          </a>
        </article>
      {% endfor %}
    {% else %}
      <div class="card card--accent-lr" style="padding:14px;">
        <strong>No properties found.</strong>
        <p class="muted" style="margin:6px 0 0 0;">Add some listings or adjust your filters.</p>
      </div>
    {% endif %}
  </div>
</section>

<style>
  /* === Card look: faint orange background (match highlights/key details style) === */
  .property-card{
    background:#FFF7E6;           /* soft orange */
    border-color:#FFD8A8;         /* warmer border */
  }
  .property-card .badge{
    background:#f0e9fb;
    color:#5c2ea5;
    border:1px solid var(--border);
    font-weight:600;
  }

  /* Equal-sized feature badges: 3 per row, wrap as needed */
  .badges-3{
    display:grid;
    grid-template-columns: repeat(3, minmax(0,1fr));
    gap:8px;
  }
  @media (max-width: 700px){
    .badges-3{
      grid-template-columns: repeat(2, minmax(0,1fr));
    }
  }
  @media (max-width: 460px){
    .badges-3{
      grid-template-columns: 1fr;
    }
  }
  .badges-3 .badge{
    width:100%;
    text-align:center;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  .prop-title{
    margin:0;
    font-size:16px;
    line-height:1.2;
    color:var(--brand);
  }
  .price-line{
    margin-top:10px;
    font-weight:700;
    color:#222;
  }
</style>

<script>
  // Short street extractor (no house number), reuse logic client-side
  (function(){
    function extractStreet(line1){
      if (!line1) return "";
      var keep = line1;
      // Try to drop leading number or flat/unit prefixes
      keep = keep.replace(/^(\d+[A-Za-z\-]*\s+|flat\s*\d+\s+|ap(?:artment)?\s*\d+\s+|suite\s*\d+\s+)/i, "").trim();

      // Keep last token up to a common street type to avoid whole address
      var types = [' Road',' Street',' Avenue',' Lane',' Close',' Drive',' Terrace',' Way',' Place',' Crescent',' Court',' Hill',' Gardens',' Park',' Grove',' View',' Parade',' Square',' Row',' Mews'];
      var hitIdx = -1;
      for (var i=0;i<types.length;i++){
        var t = types[i];
        var idx = keep.toLowerCase().lastIndexOf(t.toLowerCase());
        if (idx !== -1){ hitIdx = idx + t.length; break; }
      }
      if (hitIdx !== -1){
        // Get the word block ending at the type
        keep = keep.slice(0, hitIdx).trim();
      }
      return keep || line1;
    }

    document.querySelectorAll('.short-address').forEach(function(el){
      var full = el.getAttribute('data-full') || '';
      var parts = full.split(',').map(function(s){ return s.trim(); }).filter(Boolean);
      if (parts.length){
        var street = extractStreet(parts[0]);
        var rest = parts.slice(1).join(', ');
        el.textContent = rest ? (street + ', ' + rest) : street;
      }else{
        el.textContent = full;
      }
    });
  })();
</script>
{% endblock %}
