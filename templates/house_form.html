{% extends "base.html" %}
{% block title %}{{ 'Add house' if mode=='new' else 'Edit house' }} – Student Palace{% endblock %}
{% block content %}
<section class="wrap">
  <h1>{{ 'Add a house' if mode=='new' else 'Edit house' }}</h1>

  <form method="post" class="card" id="house-form">
    <div class="grid grid-2">
      <label class="field">
        <span class="label">Title</span>
        <input type="text" name="title" value="{{ (form.title or '') if form else '' }}" required>
      </label>

      <label class="field">
        <span class="label">City</span>
        <select name="city" id="city_select" required>
          <option value="">Select a city</option>
          {% for c in cities %}
            <option value="{{ c }}" {% if form and form.city==c %}selected{% endif %}>{{ c }}</option>
          {% endfor %}
        </select>
        <p class="help">Only admin-listed cities are available.</p>
      </label>

      <!-- Address block -->
      <div class="card card--accent-edges" style="grid-column:1 / -1">
        <h3 class="mt-0">Address</h3>

        <input type="hidden" name="address" id="address_hidden" value="{{ (form.address or '') if form else '' }}">

        <div class="grid grid-3">
          <label class="field">
            <span class="label">Flat number</span>
            <input type="text" name="flat_number" id="flat_number" value="{{ (form.flat_number or '') if form else '' }}">
          </label>

          <label class="field">
            <span class="label">House name</span>
            <input type="text" name="house_name" id="house_name" value="{{ (form.house_name or '') if form else '' }}">
          </label>

          <label class="field">
            <span class="label">House number</span>
            <input type="text" name="house_number" id="house_number" value="{{ (form.house_number or '') if form else '' }}">
          </label>

          <label class="field" style="grid-column:1 / -1">
            <span class="label">Street name</span>
            <input type="text" name="street_name" id="street_name" value="{{ (form.street_name or '') if form else '' }}" required>
          </label>

          <label class="field" style="grid-column:1 / -1">
            <span class="label">Extra address info (optional)</span>
            <input type="text" name="address_extra" id="address_extra" value="{{ (form.address_extra or '') if form else '' }}">
          </label>

          <label class="field">
            <span class="label">Town (optional)</span>
            <input type="text" name="town" id="town" value="{{ (form.town or '') if form else '' }}">
          </label>

          <label class="field">
            <span class="label">Postcode</span>
            <input type="text" name="postcode" id="postcode" value="{{ (form.postcode or '') if form else '' }}" required>
          </label>
        </div>

        <div class="address-preview">
          <span class="label">Preview:</span>
          <p id="address_preview" class="mono small">{{ (form.address or '') if form else '' }}</p>
        </div>
      </div>
      <!-- End Address block -->

      <!-- EPC rating dropdown -->
      <label class="field">
        <span class="label">EPC rating</span>
        {% set epc_val = (form.epc_rating or '') if form else '' %}
        <select name="epc_rating" id="epc_rating">
          <option value="" {% if not epc_val %}selected{% endif %}>Please choose</option>
          {% for rating in ['A','B','C','D','E','F','G'] %}
            <option value="{{ rating }}" {% if epc_val==rating %}selected{% endif %}>{{ rating }}</option>
          {% endfor %}
        </select>
        <p class="help">Select the property’s Energy Performance Certificate band.</p>
      </label>
      <!-- End EPC rating -->

      <label class="field">
        <span class="label">Letting type</span>
        <select name="letting_type" required>
          <option value="whole" {% if form and form.letting_type=='whole' %}selected{% endif %}>Whole property</option>
          <option value="share" {% if form and form.letting_type=='share' %}selected{% endif %}>House share (rooms)</option>
        </select>
      </label>

      <label class="field">
        <span class="label">Bedrooms (total)</span>
        <input type="number" name="bedrooms_total" min="1" value="{{ (form.bedrooms_total or 1) if form else 1 }}" required>
      </label>

      <label class="field">
        <span class="label">I want a house that is</span>
        <select name="gender_preference" required>
          {% set g = (form.gender_preference or '') if form else '' %}
          <option value="" {% if not g %}selected{% endif %}>Please choose one</option>
          <option value="Male" {% if g=='Male' %}selected{% endif %}>Male</option>
          <option value="Female" {% if g=='Female' %}selected{% endif %}>Female</option>
          <option value="Either" {% if g=='Either' %}selected{% endif %}>Anything</option>
          <option value="Mixed" {% if g=='Mixed' %}selected{% endif %}>Mixed</option>
        </select>
      </label>

      {% set bi = (form.bills_option or 'no') if form else 'no' %}
      <label class="field">
        <span class="label">Bills included</span>
        <select name="bills_included" id="bills_included">
          <option value="no" {% if bi=='no' %}selected{% endif %}>No</option>
          <option value="yes" {% if bi=='yes' %}selected{% endif %}>Yes</option>
          <option value="some" {% if bi=='some' %}selected{% endif %}>Some</option>
        </select>
        <p class="help">Choose “Some” to specify which utilities are covered.</p>
      </label>

      <label class="field" style="grid-column:1 / -1">
        <span class="label">This house is listed as</span>
        {% set lt = (form.listing_type or default_listing_type or 'owner') if form is not none else (default_listing_type or 'owner') %}
        <select name="listing_type" required>
          <option value="owner" {% if lt=='owner' %}selected{% endif %}>Owner</option>
          <option value="agent" {% if lt=='agent' %}selected{% endif %}>Agent</option>
        </select>
        <p class="help">Defaults to your profile preference; you can change per house.</p>
      </label>
    </div>

    <!-- Bills utilities block, bathrooms, house info... (unchanged) -->

    <div style="margin-top:14px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn" type="submit">{{ 'Create house' if mode=='new' else 'Save changes' }}</button>
      <a class="btn" href="{{ url_for('landlord.landlord_houses') }}">Cancel</a>
    </div>
  </form>
</section>

<script>
  (function () {
    const billsSelect = document.getElementById('bills_included');
    const utilBox = document.getElementById('bills-utilities');
    const utilIds = ['bills_util_gas','bills_util_electric','bills_util_water','bills_util_broadband','bills_util_tv'];
    const getChecks = () => utilIds.map(id => document.getElementById(id)).filter(Boolean);

    function syncUtilitiesVisibility() {
      const val = billsSelect.value;
      if (val === 'some') {
        utilBox.style.display = '';
      } else {
        utilBox.style.display = 'none';
        const checks = getChecks();
        if (val === 'yes') {
          checks.forEach(c => c.checked = true);
        } else {
          checks.forEach(c => c.checked = false);
        }
      }
    }
    billsSelect.addEventListener('change', syncUtilitiesVisibility);
    syncUtilitiesVisibility();

    // Address composer
    const el = id => document.getElementById(id);
    const fields = ['flat_number','house_name','house_number','street_name','address_extra','town','postcode'];
    const citySel = document.getElementById('city_select');
    const hidden = document.getElementById('address_hidden');
    const preview = document.getElementById('address_preview');

    function normalizePostcode(pc) {
      pc = (pc || '').toUpperCase().trim();
      if (pc.length > 3 && !pc.includes(' ')) {
        pc = pc.slice(0, -3) + ' ' + pc.slice(-3);
      }
      return pc;
    }

    function composeAddress() {
      const v = {};
      fields.forEach(f => v[f] = (el(f)?.value || '').trim());
      const city = (citySel?.value || '').trim();

      v.postcode = normalizePostcode(v.postcode);

      const line1 = [v.flat_number, (v.house_name || v.house_number), v.street_name].filter(Boolean).join(' ');
      const line2 = v.address_extra ? v.address_extra : '';
      const line3 = [v.town, city].filter(Boolean).join(', ');
      const parts = [line1, line2, line3, v.postcode].filter(s => s && s.replace(/[, ]+/g,'').length);
      const composed = parts.join(', ');

      hidden.value = composed;
      if (preview) preview.textContent = composed;
    }

    fields.forEach(f => el(f)?.addEventListener('input', composeAddress));
    citySel?.addEventListener('change', composeAddress);
    composeAddress();

    document.getElementById('house-form').addEventListener('submit', function (e) {
      composeAddress();
      if (!el('street_name').value.trim() || !el('postcode').value.trim() || !hidden.value.trim()) {
        e.preventDefault();
        alert('Please complete Street name and Postcode.');
      }
    });
  })();
</script>

<style>
  .address-preview { margin-top: 8px; }
  .address-preview .label { font-weight: 600; margin-right: 8px; }
  .address-preview .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
  .address-preview .small { font-size: 0.9rem; opacity: 0.85; }
</style>
{% endblock %}
