{% extends "base.html" %}
{% block title %}{{ 'Add house' if mode=='new' else 'Edit house' }} – Student Palace{% endblock %}
{% block content %}
<section class="wrap">
  <h1>{{ 'Add a house' if mode=='new' else 'Edit house' }}</h1>

  <form method="post" class="card" id="house-form">
    <div class="grid grid-2">
      <label class="field">
        <span class="label">Title</span>
        <input type="text" name="title" value="{{ (form.title or '') if form else '' }}" required>
      </label>

      <label class="field">
        <span class="label">City</span>
        <select name="city" required>
          <option value="">Select a city</option>
          {% for c in cities %}
            <option value="{{ c }}" {% if form and form.city==c %}selected{% endif %}>{{ c }}</option>
          {% endfor %}
        </select>
        <p class="help">Only admin-listed cities are available.</p>
      </label>

      <label class="field" style="grid-column:1 / -1">
        <span class="label">Address</span>
        <input type="text" name="address" value="{{ (form.address or '') if form else '' }}" required>
      </label>

      <label class="field">
        <span class="label">Letting type</span>
        <select name="letting_type" required>
          <option value="whole" {% if form and form.letting_type=='whole' %}selected{% endif %}>Whole property</option>
          <option value="share" {% if form and form.letting_type=='share' %}selected{% endif %}>House share (rooms)</option>
        </select>
      </label>

      <label class="field">
        <span class="label">Bedrooms (total)</span>
        <input type="number" name="bedrooms_total" min="1" value="{{ (form.bedrooms_total or 1) if form else 1 }}" required>
      </label>

      <label class="field">
        <span class="label">I want a house that is</span>
        <select name="gender_preference" required>
          {% set g = (form.gender_preference or '') if form else '' %}
          <option value="" {% if not g %}selected{% endif %}>Please choose one</option>
          <option value="Male" {% if g=='Male' %}selected{% endif %}>Male</option>
          <option value="Female" {% if g=='Female' %}selected{% endif %}>Female</option>
          <option value="Either" {% if g=='Either' %}selected{% endif %}>Anything</option>
          <option value="Mixed" {% if g=='Mixed' %}selected{% endif %}>Mixed</option>
        </select>
      </label>

      <!-- Bills included (dropdown) – saved in DB as houses.bills_option -->
      <label class="field">
        <span class="label">Bills included</span>
        {% set bi = (form.bills_option or 'no') if form else 'no' %}
        <select name="bills_included" id="bills_included">
          <option value="no" {% if bi=='no' %}selected{% endif %}>No</option>
          <option value="yes" {% if bi=='yes' %}selected{% endif %}>Yes</option>
          <option value="some" {% if bi=='some' %}selected{% endif %}>Some</option>
        </select>
        <p class="help">Choose “Some” to specify which utilities are covered.</p>
      </label>

      <!-- Placeholder for price (not wired yet) -->
      <label class="field">
        <span class="label">Price (placeholder)</span>
        <input type="text" name="price_placeholder" placeholder="£— coming soon" value="" disabled>
        <p class="help">We’ll add pricing logic later.</p>
      </label>

      <!-- Listing type (Owner/Agent) -->
      <label class="field" style="grid-column:1 / -1">
        <span class="label">This house is listed as</span>
        {% set lt = (form.listing_type or default_listing_type or 'owner') if form is not none else (default_listing_type or 'owner') %}
        <select name="listing_type" required>
          <option value="owner" {% if lt=='owner' %}selected{% endif %}>Owner</option>
          <option value="agent" {% if lt=='agent' %}selected{% endif %}>Agent</option>
        </select>
        <p class="help">Defaults to your profile preference; you can change per house.</p>
      </label>
    </div>

    <h3 style="margin-top:14px">Bathrooms</h3>
    <div class="grid">
      <label class="field">
        <span class="label">Shared bathrooms (number)</span>
        <input type="number" name="shared_bathrooms" min="0" value="{{ (form.shared_bathrooms or 0) if form else 0 }}">
      </label>
    </div>

    <!-- Bills details: only shown when "Some" is selected -->
    {% set show_some = (bi == 'some') %}
    <div class="card" id="bills_some_block" style="margin-top:10px; {% if not show_some %}display:none;{% endif %}">
      <h3 class="mt-0">Bills breakdown (when “Some” selected)</h3>
      <div class="grid grid-3">
        <label class="field checkbox">
          {% set util_gas = (form.bills_util_gas in ['1',1,'on',True]) if form else False %}
          <input type="checkbox" name="bills_util_gas" id="bills_util_gas" {% if util_gas %}checked{% endif %}>
          <span>Gas</span>
        </label>
        <label class="field checkbox">
          {% set util_elec = (form.bills_util_electric in ['1',1,'on',True]) if form else False %}
          <input type="checkbox" name="bills_util_electric" id="bills_util_electric" {% if util_elec %}checked{% endif %}>
          <span>Electric</span>
        </label>
        <label class="field checkbox">
          {% set util_water = (form.bills_util_water in ['1',1,'on',True]) if form else False %}
          <input type="checkbox" name="bills_util_water" id="bills_util_water" {% if util_water %}checked{% endif %}>
          <span>Water</span>
        </label>
        <label class="field checkbox">
          {% set util_bb = (form.bills_util_broadband in ['1',1,'on',True]) if form else False %}
          <input type="checkbox" name="bills_util_broadband" id="bills_util_broadband" {% if util_bb %}checked{% endif %}>
          <span>Broadband</span>
        </label>
        <label class="field checkbox">
          {% set util_tv = (form.bills_util_tv in ['1',1,'on',True]) if form else False %}
          <input type="checkbox" name="bills_util_tv" id="bills_util_tv" {% if util_tv %}checked{% endif %}>
          <span>TV licence</span>
        </label>
      </div>
      <p class="help" style="margin-top:6px">Tick the utilities that are included in the rent.</p>
    </div>

    <h3 style="margin-top:14px">House Info</h3>

    <div class="grid grid-3">
      <label class="field">
        <span class="label">Cleaning service</span>
        {% set cs = (form.cleaning_service or 'none') if form else 'none' %}
        <select name="cleaning_service">
          {% for opt in ['none','weekly','fortnightly','monthly'] %}
            <option value="{{ opt }}" {% if cs==opt %}selected{% endif %}>
              {{ 'None' if opt=='none' else opt|capitalize }}
            </option>
          {% endfor %}
        </select>
        <p class="help">If “None”, we won’t show cleaning info on the property page.</p>
      </label>

      <label class="field checkbox">
        <input type="checkbox" name="washing_machine" {% if (not form) or form.washing_machine in ['1',1,'on',True] %}checked{% endif %}>
        <span>Washing machine</span>
      </label>
      <label class="field checkbox">
        <input type="checkbox" name="tumble_dryer" {% if form and form.tumble_dryer in ['1',1,'on',True] %}checked{% endif %}>
        <span>Tumble dryer</span>
      </label>
      <label class="field checkbox">
        <input type="checkbox" name="dishwasher" {% if form and form.dishwasher in ['1',1,'on',True] %}checked{% endif %}>
        <span>Dishwasher</span>
      </label>
      <label class="field checkbox">
        <input type="checkbox" name="cooker" {% if (not form) or form.cooker in ['1',1,'on',True] %}checked{% endif %}>
        <span>Cooker</span>
      </label>
      <label class="field checkbox">
        <input type="checkbox" name="microwave" {% if form and form.microwave in ['1',1,'on',True] %}checked{% endif %}>
        <span>Microwave</span>
      </label>
      <label class="field checkbox">
        <input type="checkbox" name="coffee_maker" {% if form and form.coffee_maker in ['1',1,'on',True] %}checked{% endif %}>
        <span>Coffee maker</span>
      </label>
      <label class="field checkbox">
        <input type="checkbox" name="central_heating" {% if (not form) or form.central_heating in ['1',1,'on',True] %}checked{% endif %}>
        <span>Central heating</span>
      </label>
      <label class="field checkbox">
        <input type="checkbox" name="air_conditioning" {% if form and form.air_conditioning in ['1',1,'on',True] %}checked{% endif %}>
        <span>Air conditioning</span>
      </label>
      <label class="field checkbox">
        <input type="checkbox" name="vacuum" {% if form and form.vacuum in ['1',1,'on',True] %}checked{% endif %}>
        <span>Vacuum</span>
      </label>
      <label class="field checkbox">
        <input type="checkbox" name="wifi" {% if (not form) or form.wifi in ['1',1,'on',True] %}checked{% endif %}>
        <span>Wi-Fi</span>
      </label>
      <label class="field checkbox">
        <input type="checkbox" name="wired_internet" {% if form and form.wired_internet in ['1',1,'on',True] %}checked{% endif %}>
        <span>Wired internet</span>
      </label>
      <label class="field checkbox">
        <input type="checkbox" name="common_area_tv" {% if form and form.common_area_tv in ['1',1,'on',True] %}checked{% endif %}>
        <span>Common area TV</span>
      </label>
      <label class="field checkbox">
        <input type="checkbox" name="cctv" {% if form and form.cctv in ['1',1,'on',True] %}checked{% endif %}>
        <span>CCTV</span>
      </label>
      <label class="field checkbox">
        <input type="checkbox" name="video_door_entry" {% if form and form.video_door_entry in ['1',1,'on',True] %}checked{% endif %}>
        <span>Video door entry</span>
      </label>
      <label class="field checkbox">
        <input type="checkbox" name="fob_entry" {% if form and form.fob_entry in ['1',1,'on',True] %}checked{% endif %}>
        <span>Fob entry</span>
      </label>
      <label class="field checkbox">
        <input type="checkbox" name="off_street_parking" {% if form and form.off_street_parking in ['1',1,'on',True] %}checked{% endif %}>
        <span>Off-street parking available</span>
      </label>
      <label class="field checkbox">
        <input type="checkbox" name="local_parking" {% if form and form.local_parking in ['1',1,'on',True] %}checked{% endif %}>
        <span>Local parking available</span>
      </label>
      <label class="field checkbox">
        <input type="checkbox" name="garden" {% if form and form.garden in ['1',1,'on',True] %}checked{% endif %}>
        <span>Garden</span>
      </label>
      <label class="field checkbox">
        <input type="checkbox" name="roof_terrace" {% if form and form.roof_terrace in ['1',1,'on',True] %}checked{% endif %}>
        <span>Roof terrace</span>
      </label>
      <label class="field checkbox">
        <input type="checkbox" name="bike_storage" {% if form and form.bike_storage in ['1',1,'on',True] %}checked{% endif %}>
        <span>Bike storage</span>
      </label>
      <label class="field checkbox">
        <input type="checkbox" name="games_room" {% if form and form.games_room in ['1',1,'on',True] %}checked{% endif %}>
        <span>Games room</span>
      </label>
      <label class="field checkbox">
        <input type="checkbox" name="cinema_room" {% if form and form.cinema_room in ['1',1,'on',True] %}checked{% endif %}>
        <span>Cinema room</span>
      </label>
    </div>

    <div style="margin-top:14px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn" type="submit">{{ 'Create house' if mode=='new' else 'Save changes' }}</button>
      <a class="btn" href="{{ url_for('landlord.landlord_houses') }}">Cancel</a>
    </div>
  </form>
</section>

<script>
// Bills UI logic:
// - "no"  => hide details, uncheck all utilities
// - "yes" => hide details, check all utilities
// - "some"=> show details, leave user selections as-is (server will persist)
(function() {
  const select = document.getElementById('bills_included');
  const block  = document.getElementById('bills_some_block');
  const utilIds = ['bills_util_gas','bills_util_electric','bills_util_water','bills_util_broadband','bills_util_tv'];
  const utils = utilIds.map(id => document.getElementById(id));

  function setUtils(checked) {
    utils.forEach(cb => { if (cb) cb.checked = checked; });
  }

  function updateVisibility() {
    const v = (select.value || 'no').toLowerCase();
    if (v === 'some') {
      block.style.display = '';
    } else {
      block.style.display = 'none';
      if (v === 'yes') setUtils(true);
      else setUtils(false); // 'no'
    }
  }

  if (select && block) {
    // On load: enforce initial state (handles Edit + New consistently)
    updateVisibility();
    // On change: apply rules
    select.addEventListener('change', updateVisibility);
  }
})();
</script>
{% endblock %}
