# public_landlord.py (or wherever your public routes live)
from __future__ import annotations

from flask import Blueprint, render_template, abort
from db import get_db

bp = Blueprint("public", __name__)

@bp.route("/landlord/<slug>")
def landlord_public_profile(slug: str):
    conn = get_db()
    try:
        # 1) Profile by public_slug
        profile = conn.execute(
            """
            SELECT *
            FROM landlord_profiles
            WHERE public_slug = ?
            """,
            (slug,),
        ).fetchone()

        if not profile:
            # Render the same template with profile=None so it shows the "not found" state
            return render_template(
                "landlord_public_profile.html",
                profile=None,
                contact_email=None,
                accreditations=[],
            )

        landlord_id = profile["landlord_id"]

        # 2) Contact email from landlords table
        row = conn.execute(
            "SELECT email FROM landlords WHERE id = ?",
            (landlord_id,),
        ).fetchone()
        contact_email = row["email"] if row else None

        # 3) Accreditations (IMPORTANT: use accreditation_id)
        accreditations = conn.execute(
            """
            SELECT
              at.id,
              at.name,
              COALESCE(la.note, la.extra_text, '') AS note,
              COALESCE(at.help_text, '') AS help_text
            FROM landlord_accreditations AS la
            JOIN accreditation_types     AS at
              ON at.id = la.accreditation_id
            WHERE la.landlord_id = ?
              AND at.is_active = 1
            ORDER BY at.sort_order ASC, at.name ASC
            """,
            (landlord_id,),
        ).fetchall()

        # 4) Increment profile views (non-fatal if it fails)
        try:
            conn.execute(
                "UPDATE landlord_profiles SET profile_views = COALESCE(profile_views,0) + 1 WHERE landlord_id = ?",
                (landlord_id,),
            )
            conn.commit()
        except Exception:
            pass

        return render_template(
            "landlord_public_profile.html",
            profile=profile,
            contact_email=contact_email,
            accreditations=accreditations,
        )
    finally:
        try:
            conn.close()
        except Exception:
            pass
