{% extends "base.html" %}
{% block title %}{{ (house.title or 'Property') ~ ' – Student Palace' if house else 'Property – Student Palace' }}{% endblock %}
{% block content %}
<section class="wrap">

  {% if not house %}
    <h1>Property not found</h1>
    <div class="card card--accent-lr"><p class="help">This listing doesn’t exist.</p></div>
  {% else %}

    <!-- Header -->
    <div class="card card--accent-lr">
      <div class="flex-between" style="gap:10px; align-items:baseline">
        <h1 class="mt-0" style="margin:0">{{ house.title or 'Student property' }}</h1>
        {% if profile and profile.public_slug %}
          <a href="/l/{{ profile.public_slug }}" class="small" style="text-decoration:none">View landlord</a>
        {% endif %}
      </div>
      <p class="muted" style="margin:6px 0 0">
        {{ house.city or '' }}
        {% if profile and profile.display_name %}
          &nbsp;•&nbsp; {{ profile.display_name }}
        {% endif %}
      </p>

      <!-- Verified / not verified banner -->
      {% if profile and (profile.is_verified|default(0, true)) %}
        <div class="card card--accent-lr" style="display:flex;align-items:center;gap:10px;padding:10px 12px;margin:14px 0 0">
          <span aria-hidden="true" style="font-size:20px">✅</span>
          <div style="font-weight:600">Verified landlord – listings from this owner/agent display a green tick.</div>
        </div>
      {% else %}
        <div class="card card--accent-lr" style="display:flex;align-items:center;gap:10px;padding:10px 12px;margin:14px 0 0">
          <span aria-hidden="true" style="font-size:20px">❌</span>
          <div style="font-weight:600">Not verified – Get verified to boost renter trust.</div>
        </div>
      {% endif %}
    </div>

    <!-- Gallery -->
    <div class="card card--accent-lr">
      <h2 style="margin:0 0 10px">Photos</h2>
      {% set imgs = images or [] %}
      {% if imgs and imgs|length > 0 %}
        <div class="grid" style="grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap:10px">
          {% for im in imgs[:5] %}
            <div style="width:100%; aspect-ratio:16/9; border:1px solid var(--border); border-radius:12px; overflow:hidden; background:#f6f3ff">
              <img
                src="{{ url_for('static', filename=im.file_path) }}"
                alt="Property photo {{ loop.index }}"
                style="width:100%; height:100%; object-fit:cover">
            </div>
          {% endfor %}
        </div>
        {% if imgs|length > 5 %}
          <p class="help" style="margin-top:6px">{{ imgs|length - 5 }} more photos not shown.</p>
        {% endif %}
      {% else %}
        <p class="help" style="margin:0">No photos yet.</p>
      {% endif %}
    </div>

    <!-- Key info -->
    <div class="card card--accent-lr">
      <h2 style="margin:0 0 10px">Key details</h2>
      <div class="inline-actions" style="gap:8px">
        {% if house.bedrooms_total %}
          <span class="badge">{{ house.bedrooms_total }} bedrooms</span>
        {% endif %}
        {% if house.letting_type in ['whole','share'] %}
          <span class="badge">{{ 'Whole property' if house.letting_type == 'whole' else 'Room by room' }}</span>
        {% endif %}
        {% if house.bills_included or (house.bills_option and house.bills_option|lower != 'no') %}
          <span class="badge">Bills included</span>
        {% endif %}
        {% if house.gender_preference %}
          <span class="badge">{{ house.gender_preference }}</span>
        {% endif %}
      </div>
      {% if house.address %}
        <p class="muted" style="margin-top:10px">{{ house.address }}</p>
      {% endif %}
    </div>

    <!-- Description -->
    <div class="card card--accent-lr">
      <h2 style="margin:0 0 10px">Description</h2>
      <p style="white-space:pre-wrap">{{ (house.description or '') | trim if house.description is defined else (profile.bio or 'No description provided yet.') }}</p>
    </div>

    <!-- Rooms -->
    <div class="card card--accent-lr">
      <h2 style="margin:0 0 10px">Rooms</h2>
      {% set rs = rooms or [] %}
      {% if rs and rs|length > 0 %}
        <table class="table">
          <thead>
            <tr>
              <th>Room</th>
              <th>Bed</th>
              <th>Ensuite</th>
              <th>Price (pcm)</th>
              <th>Available from</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            {% for r in rs %}
              <tr>
                <td>{{ r.name or ('Room ' ~ loop.index) }}</td>
                <td>{{ r.bed_size or '—' }}</td>
                <td>{{ 'Yes' if r.ensuite else 'No' }}</td>
                <td>
                  {% if r.price_pcm and r.price_pcm|int > 0 %}
                    £{{ r.price_pcm|int }}
                  {% else %}—{% endif %}
                </td>
                <td>{{ r.available_from or '—' }}</td>
                <td>
                  {% if r.is_let %}Let
                  {% else %}Available{% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        {% if house.letting_type == 'whole' %}
          <p class="help" style="margin:0">Whole property letting – contact the landlord to enquire.</p>
        {% else %}
          <p class="help" style="margin:0">No room details yet.</p>
        {% endif %}
      {% endif %}
    </div>

    <!-- Call to action -->
    <div class="card card--accent-lr">
      <div class="flex-between" style="gap:8px">
        <p style="margin:0; font-weight:600">Interested in this property?</p>
        <div class="inline-actions">
          <a class="btn" href="/contact?house_id={{ house.id }}">Request viewing</a>
          <form method="post" action="/shortlist/toggle" style="display:inline">
            <input type="hidden" name="house_id" value="{{ house.id }}">
            <button class="btn btn-outline" type="submit">Save to shortlist</button>
          </form>
        </div>
      </div>
      {% if profile and profile.display_name %}
        <p class="muted" style="margin-top:8px">
          Listed by {{ profile.display_name }}{% if contact_email %} • {{ contact_email }}{% endif %}
        </p>
      {% endif %}
    </div>

  {% endif %}
</section>
{% endblock %}
