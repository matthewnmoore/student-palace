{% extends "base.html" %}
{% block title %}Admin · Images{% endblock %}
{% block content %}
<section class="wrap">
  <div class="flex-between" style="margin-bottom:12px">
    <h1 class="mt-0">All Images (Admin)</h1>
    <div class="inline-actions">
      <a class="btn {% if broken_only %}btn-outline{% endif %}" href="{{ url_for('admin.admin_images') }}">All</a>
      <a class="btn {% if not broken_only %}btn-outline{% endif %}" href="{{ url_for('admin.admin_images', broken=1) }}">Broken only</a>
      <form method="post" action="{{ url_for('admin.admin_images_cleanup_broken') }}" style="display:inline" onsubmit="return confirm('Delete ALL broken image rows? This cannot be undone.');">
        <button class="btn btn-admin" type="submit">Delete all broken</button>
      </form>
    </div>
  </div>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="flash {{ category }}">{{ message }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <div class="card">
    {% if items and items|length %}
      <table class="table">
        <thead>
          <tr>
            <th>ID</th>
            <th>House</th>
            <th>Filename</th>
            <th>Exists</th>
            <th>Size</th>
            <th>Bytes</th>
            <th>Primary</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
        {% for it in items %}
          <tr>
            <td>{{ it.id }}</td>
            <td>{{ it.house_id }}</td>
            <td class="small">
              <div><strong>{{ it.filename }}</strong></div>
              <div class="muted">{{ it.file_path }}</div>
              <div class="muted small">{{ it.created_at }}</div>
            </td>
            <td>
              {% if it.exists %}
                <span class="badge">yes</span>
              {% else %}
                <span class="badge" style="background:#fce8e6;color:#b00020;">no</span>
              {% endif %}
            </td>
            <td>{{ it.width }}×{{ it.height }}</td>
            <td>{{ it.bytes }}</td>
            <td>{% if it.is_primary %}✔{% else %}&nbsp;{% endif %}</td>
            <td>
              <form method="post" action="{{ url_for('admin.admin_images_delete', img_id=it.id) }}" onsubmit="return confirm('Delete this image? This removes the DB row and (if present) the file.');">
                <button class="btn btn-admin" type="submit">Delete</button>
              </form>
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>

      <div class="flex-between" style="margin-top:10px">
        <div class="muted small">
          Showing page {{ page }} (limit {{ limit }}). Total in DB: {{ total }}.
        </div>
        <div class="inline-actions">
          {% if prev_url %}
            <a class="btn btn-outline" href="{{ prev_url }}">&larr; Prev</a>
          {% endif %}
          {% if next_url %}
            <a class="btn btn-outline" href="{{ next_url }}">Next &rarr;</a>
          {% endif %}
        </div>
      </div>
    {% else %}
      <p class="muted">No images found for this view.</p>
    {% endif %}
  </div>
</section>
{% endblock %}
