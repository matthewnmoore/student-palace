{% extends "base.html" %}
{% block title %}Student Palace – Find rooms{% endblock %}
{% block content %}
<section class="wrap">

  <!-- HERO / INTRO -->
  <div class="card card--accent-lr hero-centered">
    <h1 class="mt-0" style="margin-bottom:6px">Your next student home — without the faff.</h1>
    <p class="muted" style="margin-bottom:4px">
      Look out for the ✅ green tick – it means properties from verified landlords and agents.
    </p>
    <p class="muted" style="margin:0">
      Built by us, made for you – student renting made easy
    </p>
  </div>

  <!-- SEARCH -->
  <div class="card card--accent-lr">
    <h2 class="mt-0" style="text-align:center">Search Student Properties</h2>

    <form action="{{ url_for('public.search') }}" method="get" class="grid grid-2 form-compact-labels" style="max-width:820px;margin:0 auto">

      <!-- City -->
      <label class="field" style="text-align:center">
        <span class="label-inline">City</span>
        <select name="city" id="city" data-required>
          <option value="" selected>Please choose</option>
          {% for c in cities %}
            <option value="{{ c }}">{{ c }}</option>
          {% endfor %}
        </select>
      </label>

      <!-- Group size -->
      <label class="field" style="text-align:center">
        <span class="label-inline">Group size</span>
        <select name="group_size" id="group_size" data-required>
          <option value="" selected>Please choose</option>
          {% for n in range(1,10) %}
            <option value="{{ n }}">{{ n }}</option>
          {% endfor %}
        </select>
      </label>

      <!-- Academic year -->
      <label class="field" style="text-align:center">
        <span class="label-inline">Academic year</span>
        <select name="academic_year" id="academic_year" data-required>
          <option value="" selected>Please choose</option>
          {% set current_year = 2025 %}
          {% for y in range(current_year, current_year+5) %}
            {% set next = y + 1 %}
            <option value="{{ y }}/{{ next }}">{{ y }}/{{ next }}</option>
          {% endfor %}
        </select>
      </label>

      <!-- Property gender preference -->
      <label class="field" style="text-align:center; grid-column:1/-1; max-width:420px; margin:0 auto">
        <span class="label-inline">A house that identifies as</span>
        <select name="gender_pref" id="gender_pref" data-required>
          <option value="" selected>Please choose</option>
          <option value="Male">Just Male</option>
          <option value="Female">Just Female</option>
          <option value="Anything">Anything — I’m not fussed</option>
        </select>
      </label>

      <!-- Seeker gender -->
      <div id="seeker_gender_block" style="grid-column:1/-1; display:none;">
        <div class="field" style="display:flex; align-items:center; justify-content:center; gap:10px; text-align:center; max-width:780px; margin:0 auto">
          <span class="label-inline">Can I politely ask if you are male or female to help me refine your search</span>
          <select name="seeker_gender" id="seeker_gender" data-required style="max-width:320px">
            <option value="" selected>Please choose</option>
            <option value="Male">Male</option>
            <option value="Female">Female</option>
            <option value="NA">I’d rather not say</option>
          </select>
        </div>
        <p class="help" style="text-align:center; margin-top:6px">This helps us match your preferences to suitable houses.</p>
      </div>

      <!-- Preferences row -->
      <label class="field" style="grid-column:1/-1; text-align:center">
        <div class="prefs-row" style="justify-content:center">
          <label><input type="checkbox" name="ensuite"> Ensuite / own bathroom</label>
          <label><input type="checkbox" name="bills_included"> All bills included</label>
        </div>
      </label>


      <!-- Find Rooms Button (link to properties) -->
      <div style="grid-column:1/-1; text-align:center; margin-top:10px">
        <a href="{{ url_for('public.properties') }}" class="btn btn-accent" style="min-width:260px;">
        Find rooms
      </a>
    </div>

      <!-- Find Rooms Button -->
      <div style="grid-column:1/-1; text-align:center; margin-top:10px">
        <button id="find_btn" class="btn btn-accent" type="submit" style="min-width:260px; display:none">
          Find rooms
        </button>
      </div>
    </form>
  </div>

  <!-- FEATURED -->
  <div class="card card--accent-lr">
    <h2 class="mt-0">Featured this week</h2>
    <p class="muted">A popular pick in {{ cities[0] if cities else 'Cardiff' }}.</p>
    <div class="inline-actions" style="margin-top:8px">
      <a class="btn" href="{{ url_for('public.search') }}">Browse all</a>
      <a class="btn btn-outline" href="{{ url_for('public.index') }}">Back to home</a>
    </div>
  </div>

  <!-- CITY GRID -->
  {% if cities_with_meta and cities_with_meta|length %}
    <div class="card card--accent-lr" style="padding:16px">
      <div class="city-grid">
        {% for c in cities_with_meta %}
          <a class="city-card" href="{{ url_for('public.search') }}?city={{ c.name|urlencode }}">
            {% if c.image_url %}
              <div class="city-thumb" style="background-image:url('{{ c.image_url }}')">
                <span class="city-name">{{ c.name }}</span>
              </div>
            {% else %}
              <div class="city-thumb city-thumb--placeholder">
                <span class="city-initial">{{ c.name[:1] }}</span>
                <span class="city-name">{{ c.name }}</span>
              </div>
            {% endif %}
          </a>
        {% endfor %}
      </div>
    </div>
  {% endif %}

</section>

<!-- JS: seeker gender + Find button toggle -->
<script>
  (function(){
    var gp    = document.getElementById('gender_pref');
    var block = document.getElementById('seeker_gender_block');
    var sg    = document.getElementById('seeker_gender');
    var btn   = document.getElementById('find_btn');

    var requiredSelects = Array.prototype.slice.call(
      document.querySelectorAll('select[data-required]')
    );

    function revealSeekerGender(){
      if (!gp) return;
      var show = !!gp.value;
      block.style.display = show ? 'block' : 'none';
      if (!show && sg) sg.value = '';
    }

    function allSelected(){
      for (var i = 0; i < requiredSelects.length; i++){
        if (!requiredSelects[i].value) return false;
      }
      return true;
    }

    function toggleFindButton(){
      if (!btn) return;
      btn.style.display = allSelected() ? 'inline-block' : 'none';
    }

    requiredSelects.forEach(function(el){
      el.addEventListener('change', function(){
        revealSeekerGender();
        toggleFindButton();
      });
    });

    revealSeekerGender();
    toggleFindButton();
  })();
</script>
{% endblock %}
