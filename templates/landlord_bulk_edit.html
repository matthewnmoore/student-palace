<!-- templates/landlord_bulk_edit.html -->
{% extends "base.html" %}
{% block title %}Bulk edit – Student Palace{% endblock %}
{% block content %}
<section class="wrap">
  <div class="flex-between" style="margin-bottom:12px">
    <h1 class="mt-0">Bulk edit (all rooms in the house)</h1>
    <a class="btn btn-outline" href="{{ url_for('landlord.dashboard') }}">Back to dashboard</a>
  </div>

  <div class="card card--accent-lr">
    <p class="muted" style="margin-top:-4px">
      Synchronise all room prices and/or availability for every room in a house. You can still adjust individual rooms elsewhere.
    </p>

    {% if houses and houses|length %}
      <table class="table" style="margin-top:8px">
        <thead>
          <tr>
            <th>House</th>
            <th>City</th>
            <th>Rooms (avail/total)</th>
            <th style="width:240px">Set price</th>
            <th style="width:420px">Set availability<br><span class="muted small">(does not provide current status)</span></th>
            <th style="width:120px">Apply</th>
          </tr>
        </thead>
        <tbody>
        {% for h in houses %}
          <tr>
            <td><strong>{{ h.title }}</strong></td>
            <td>{{ h.city }}</td>
            <td>{{ h.rooms_avail }} / {{ h.rooms_total }}</td>

            <td>
              <form method="post" action="{{ url_for('landlord.bulk_apply', hid=h.id) }}" id="f{{ h.id }}">
                <div style="display:flex; gap:6px; align-items:center;">
                  <input type="number" name="price_pcm" inputmode="numeric" min="0" step="1"
                         value="{{ h.avg_price_pcm if h.avg_price_pcm else '' }}"
                         placeholder="{{ h.avg_price_pcm if h.avg_price_pcm else '—' }}"
                         style="width:90px">
                  <input type="text" readonly
                         value="{% if h.avg_price_pcm %}£{{ ((h.avg_price_pcm * 12 + 51) // 52)|int }} pw{% else %}—{% endif %}"
                         style="width:90px; background:#f9f9f9; border:1px solid var(--border); padding:4px; text-align:center">
                </div>
            </td>

            <td>
              <div style="display:flex; gap:12px; align-items:end; flex-wrap:wrap">
                <label class="check" style="align-self:end; white-space:nowrap">
                  <input type="checkbox" name="is_let" value="1" id="islet{{ h.id }}">
                  <span>Currently let</span>
                </label>
                <input type="hidden" name="is_let" value="0">

                <label class="field" id="lurow{{ h.id }}" style="display:none">
                  <span class="label-inline" style="margin-bottom:0">Let until</span>
                  <input type="date" name="let_until" id="lu{{ h.id }}">
                </label>

                <label class="field" id="afrow{{ h.id }}">
                  <span class="label-inline" style="margin-bottom:0">Available from</span>
                  <input type="date" name="available_from" id="af{{ h.id }}">
                </label>
              </div>
            </td>

            <td>
              <button class="btn" type="submit" form="f{{ h.id }}">Apply</button>
              </form>
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p class="muted">No houses found.</p>
    {% endif %}
  </div>
</section>

<script>
(function(){
  function fmt(d){ const z=n=>String(n).padStart(2,'0'); return d.getFullYear()+'-'+z(d.getMonth()+1)+'-'+z(d.getDate()); }
  function nextJune30(from){
    const y = from.getMonth()+1 > 6 || (from.getMonth()+1===6 && from.getDate()>30) ? from.getFullYear()+1 : from.getFullYear();
    return new Date(y, 5, 30); // month is 0-based
  }
  function plusDays(iso, n){
    if(!iso) return '';
    const d=new Date(iso); if(isNaN(d)) return '';
    d.setDate(d.getDate()+n); return fmt(d);
  }

  {% for h in houses %}
    (function(){
      const isLet = document.getElementById('islet{{ h.id }}');
      const luRow = document.getElementById('lurow{{ h.id }}');
      const afRow = document.getElementById('afrow{{ h.id }}');
      const lu = document.getElementById('lu{{ h.id }}');
      const af = document.getElementById('af{{ h.id }}');

      function sync(){
        const now = new Date();
        if(isLet && isLet.checked){
          // Show 'let until'; default to next 30 June; ensure af = +1 day
          if(luRow) luRow.style.display='';
          const defLU = fmt(nextJune30(now));
          if(!lu.value) lu.value = defLU;
          if(!af.value || new Date(af.value) <= new Date(lu.value)){
            af.value = plusDays(lu.value, 1);
          }
        } else {
          // Hide 'let until'; default af=today; ensure lu = day before
          if(luRow) luRow.style.display='none';
          if(!af.value) af.value = fmt(now);
          if(!lu.value || new Date(lu.value) >= new Date(af.value)){
            lu.value = plusDays(af.value, -1);
          }
        }
      }
      if(isLet){ isLet.addEventListener('change', sync); }
      if(lu){ lu.addEventListener('change', sync); }
      if(af){ af.addEventListener('change', sync); }
      sync();
    })();
  {% endfor %}
})();
</script>
{% endblock %}
