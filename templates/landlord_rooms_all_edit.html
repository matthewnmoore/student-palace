{% extends "base.html" %}
{% block title %}Portfolio (room edits) – Student Palace{% endblock %}
{% block content %}
<section class="wrap">
  <div class="flex-between" style="margin-bottom:12px">
    <h1 class="mt-0">Portfolio (edit rooms)</h1>
    <a class="btn btn-outline" href="{{ url_for('landlord.dashboard') }}">Back to dashboard</a>
  </div>

  <div class="card card--accent-lr">
    <p class="muted" style="margin-top:-4px">
      Edit price and availability for individual rooms across all your houses.
    </p>

    {% if rooms and rooms|length %}
      <table class="table" style="margin-top:8px">
        <thead>
          <tr>
            <th>City</th>
            <th>House</th>
            <th>Room</th>
            <th style="width:120px">£ PPM</th>
            <th style="width:420px">Availability</th>
            <th style="width:120px">Apply</th>
          </tr>
        </thead>
        <tbody>
        {% for r in rooms %}
          <tr>
            <td>{{ r.city }}</td>
            <td><strong>{{ r.house_title }}</strong></td>
            <td>{{ r.room_name }}</td>
            <td>
              <form method="post" action="{{ url_for('landlord.rooms_portfolio_edit_apply', rid=r.room_id) }}" id="frm{{ r.room_id }}">
                <input type="number" name="price_pcm" inputmode="numeric" min="0" step="1"
                       value="{{ r.price_pcm if r.price_pcm else '' }}"
                       placeholder="{{ r.price_pcm if r.price_pcm else '—' }}"
                       style="width: 110px">
            </td>

            <td>
              <div style="display:flex; gap:12px; align-items:end; flex-wrap:wrap">
                <label class="check" style="align-self:end; white-space:nowrap">
                  <input type="checkbox" name="is_let" value="1" id="islet{{ r.room_id }}" {% if r.is_let %}checked{% endif %}>
                  <span>Currently let</span>
                </label>
                <!-- default so unchecked sends 0 -->
                <input type="hidden" name="is_let" value="0">

                <label class="field" id="lurow{{ r.room_id }}" style="display:none">
                  <span class="label-inline" style="margin-bottom:0">Let until</span>
                  <input type="date" name="let_until" id="lu{{ r.room_id }}" value="{{ r.let_until or '' }}">
                </label>

                <label class="field" id="afrow{{ r.room_id }}">
                  <span class="label-inline" style="margin-bottom:0">Available from</span>
                  <input type="date" name="available_from" id="af{{ r.room_id }}" value="{{ r.available_from or '' }}">
                </label>
              </div>
            </td>

            <td>
              <button class="btn" type="submit" form="frm{{ r.room_id }}">Apply</button>
              </form>
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p class="muted">No rooms found.</p>
    {% endif %}
  </div>
</section>

<script>
(function(){
  function fmt(d){ const z=n=>String(n).padStart(2,'0'); return d.getFullYear()+'-'+z(d.getMonth()+1)+'-'+z(d.getDate()); }
  function nextJune30(from){
    const y = (from.getMonth()+1 > 6 || ((from.getMonth()+1)===6 && from.getDate()>30)) ? from.getFullYear()+1 : from.getFullYear();
    return new Date(y, 5, 30); // June=5 (0-based)
  }
  function plusDays(iso, n){
    if(!iso) return '';
    const d=new Date(iso);
    if(isNaN(d)) return '';
    d.setDate(d.getDate()+n);
    return fmt(d);
  }

  {% for r in rooms %}
    (function(){
      const id = "{{ r.room_id }}";
      const isLet = document.getElementById('islet'+id);
      const luRow = document.getElementById('lurow'+id);
      const lu    = document.getElementById('lu'+id);
      const af    = document.getElementById('af'+id);

      function sync(){
        const now = new Date();
        if (isLet && isLet.checked){
          // Show 'let until'; default to next 30 June; ensure af = +1 day
          if (luRow) luRow.style.display = '';
          const defLU = fmt(nextJune30(now));
          if (!lu.value) lu.value = defLU;
          if (!af.value || new Date(af.value) <= new Date(lu.value)){
            af.value = plusDays(lu.value, 1);
          }
        } else {
          // Hide 'let until'; default af=today; ensure lu = day before
          if (luRow) luRow.style.display = 'none';
          if (!af.value) af.value = fmt(now);
          if (!lu.value || new Date(lu.value) >= new Date(af.value)){
            lu.value = plusDays(af.value, -1);
          }
        }
      }
      if (isLet) isLet.addEventListener('change', sync);
      if (lu) lu.addEventListener('change', sync);
      if (af) af.addEventListener('change', sync);
      sync();
    })();
  {% endfor %}
})();
</script>
{% endblock %}
