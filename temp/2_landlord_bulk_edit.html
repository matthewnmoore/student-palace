<!-- templates/landlord_bulk_edit.html -->
{% extends "base.html" %}
{% block title %}Bulk edit – Student Palace{% endblock %}
{% block content %}
<section class="wrap">
  <div class="flex-between" style="margin-bottom:12px">
    <h1 class="mt-0">Bulk edit (all rooms by house)</h1>
    <a class="btn btn-outline" href="{{ url_for('landlord.dashboard') }}">Back to dashboard</a>
  </div>

  <div class="card card--accent-lr">
    <p class="muted" style="margin-top:-4px">
      Set a single price and/or availability for every room in a house. You can still adjust individual rooms afterwards.
    </p>

    {% if houses and houses|length %}
      <table class="table" style="margin-top:8px">
        <thead>
          <tr>
            <th>House</th>
            <th>City</th>
            <th>Rooms (avail/total)</th>

            <!-- Narrow price column; heading kept as requested -->
            <th style="width:220px">Set price £/month</th>

            <!-- Wider availability column + helper -->
            <th style="width:520px">
              Set availability
              <div class="small muted" style="font-weight:normal">(does not provide current status)</div>
            </th>

            <th style="width:120px">Apply</th>
          </tr>
        </thead>
        <tbody>
        {% for h in houses %}
          <tr>
            <td><strong>{{ h.title }}</strong></td>
            <td>{{ h.city }}</td>
            <td>{{ h.rooms_avail }} / {{ h.rooms_total }}</td>

            <!-- PRICE: monthly (editable) + weekly (readonly) side-by-side, narrow inputs -->
            <td>
              <form method="post" action="{{ url_for('landlord.bulk_apply', hid=h.id) }}" id="f{{ h.id }}">
                <div style="display:flex; gap:10px; align-items:end; flex-wrap:nowrap">
                  <label class="field" style="min-width:90px">
                    <span class="label-inline" style="margin-bottom:0">£ per month</span>
                    <input type="number"
                           name="price_pcm"
                           id="pcm{{ h.id }}"
                           inputmode="numeric"
                           min="0"
                           max="9999"
                           step="1"
                           value="{{ h.avg_price_pcm if h.avg_price_pcm else '' }}"
                           placeholder="{{ h.avg_price_pcm if h.avg_price_pcm else '—' }}"
                           style="width: 90px; text-align:right">
                  </label>

                  <label class="field" style="min-width:90px">
                    <span class="label-inline" style="margin-bottom:0">Weekly rent</span>
                    <input type="text"
                           id="ppw{{ h.id }}"
                           value=""
                           readonly
                           style="width: 90px; background:#f7f7f9; text-align:right">
                  </label>
                </div>
            </td>

            <!-- AVAILABILITY (wider column) -->
            <td>
              <div style="display:flex; gap:12px; align-items:end; flex-wrap:wrap">
                <label class="check" style="align-self:end; white-space:nowrap">
                  <input type="checkbox" name="is_let" value="1" id="islet{{ h.id }}">
                  <span>Currently let</span>
                </label>
                <input type="hidden" name="is_let" value="0">

                <label class="field" id="lurow{{ h.id }}">
                  <span class="label-inline" style="margin-bottom:0">Let until</span>
                  <input type="date" name="let_until" id="lu{{ h.id }}">
                </label>

                <label class="field" id="afrow{{ h.id }}">
                  <span class="label-inline" style="margin-bottom:0">Available from</span>
                  <input type="date" name="available_from" id="af{{ h.id }}">
                </label>
              </div>
            </td>

            <td>
              <button class="btn" type="submit" form="f{{ h.id }}">Apply</button>
              </form>
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p class="muted">No houses found.</p>
    {% endif %}
  </div>
</section>

<script>
(function(){
  function fmt(d){ const z=n=>String(n).padStart(2,'0'); return d.getFullYear()+'-'+z(d.getMonth()+1)+'-'+z(d.getDate()); }
  function nextJune30(from){
    const y = from.getMonth()+1 > 6 || (from.getMonth()+1===6 && from.getDate()>30) ? from.getFullYear()+1 : from.getFullYear();
    return new Date(y, 5, 30); // 0-based month
  }
  function plusDays(iso, n){
    if(!iso) return '';
    const d=new Date(iso); if(isNaN(d)) return '';
    d.setDate(d.getDate()+n); return fmt(d);
  }

  // Monthly → Weekly, always round UP
  function pcmToPpw(val){
    const num = parseFloat(val);
    if (isNaN(num) || num <= 0) return '';
    return String(Math.ceil((num * 12) / 52));
  }

  {% for h in houses %}
    (function(){
      const id   = "{{ h.id }}";
      const pcm  = document.getElementById('pcm'+id);
      const ppw  = document.getElementById('ppw'+id);

      function clampAndSyncPPW(){
        if (!pcm || !ppw) return;
        let v = pcm.value.trim();
        let n = v === '' ? NaN : Math.max(0, Math.min(9999, Math.floor(Number(v))));
        if (!isNaN(n)) {
          if (String(n) !== v) pcm.value = String(n);
          ppw.value = pcmToPpw(n);
        } else {
          ppw.value = '';
        }
      }
      if (pcm){
        pcm.addEventListener('input', clampAndSyncPPW);
        pcm.addEventListener('change', clampAndSyncPPW);
        clampAndSyncPPW();
      }

      // Availability wiring (wider column gives both calendars room)
      const isLet = document.getElementById('islet'+id);
      const luRow = document.getElementById('lurow'+id);
      const af    = document.getElementById('af'+id);
      const lu    = document.getElementById('lu'+id);

      function syncAvail(){
        const now = new Date();
        if(isLet && isLet.checked){
          if(luRow) luRow.style.display='';
          const defLU = fmt(nextJune30(now));
          if(!lu.value) lu.value = defLU;
          if(!af.value || new Date(af.value) <= new Date(lu.value)){
            af.value = plusDays(lu.value, 1);
          }
        } else {
          if(luRow) luRow.style.display='none';
          if(!af.value) af.value = fmt(now);
          if(!lu.value || new Date(lu.value) >= new Date(af.value)){
            lu.value = plusDays(af.value, -1);
          }
        }
      }
      if(isLet){ isLet.addEventListener('change', syncAvail); }
      if(lu){ lu.addEventListener('change', syncAvail); }
      if(af){ af.addEventListener('change', syncAvail); }
      syncAvail();
    })();
  {% endfor %}
})();
</script>
{% endblock %}
